<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø²</title>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script>
        // ğŸš¨ Ù„Ø§Ø²Ù… ØªØ­Ø· Ø§Ù„Ù€ Configuration Ø¨ØªØ§Ø¹Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù‡Ù†Ø§ ÙŠØ§ Ø³Ùˆ
        const firebaseConfig = {
          apiKey: "AIzaSyBK6FZF3LW83qaUHBKYTfiVd2Ozrd1Rf2g",
          authDomain: "thanawy-1383.firebaseapp.com",
          databaseURL: "https://thanawy-1383-default-rtdb.firebaseio.com",
          projectId: "thanawy-1383",
          storageBucket: "thanawy-1383.firebasestorage.app",
          messagingSenderId: "1026664406457",
          appId: "1:1026664406457:web:87d71f7e41bef36ba0aa68",
          measurementId: "G-J5R2EFM2D0"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body { font-family: 'Cairo', sans-serif; background: #1a1a2e; color: #fff; text-align: center; padding: 20px; }
        .container { max-width: 450px; margin: 50px auto; background: #22253f; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4); }
        h1 { color: #00f5c4; margin-bottom: 20px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: none; border-radius: 8px; box-sizing: border-box; background: #333652; color: #fff; font-size: 16px; text-align: center; }
        button { width: 100%; padding: 15px; background: #00f5c4; color: #1a1a2e; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 20px; transition: 0.3s; }
        button:hover { background: #00c8a3; }
        .status { margin-top: 15px; font-weight: 700; color: #ffb347; }
        #uidDisplay { font-size: 14px; color: #a0a0b0; margin-bottom: 20px; word-break: break-all; }
        .admin-link { display: block; margin-top: 30px; color: #ffb347; text-decoration: none; font-size: 14px; }
        .divider { margin: 25px 0; border-bottom: 1px dashed #333652; padding-bottom: 10px; color: #a0a0b0; font-weight: 700; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„</h1>
        
        <form id="loginForm">
            <input type="text" id="activationCode" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ (9 Ø£Ø±Ù‚Ø§Ù…)" pattern="[0-9]{9}" maxlength="9" required />
            <button type="submit" id="submitBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            <div class="status" id="statusMessage"></div>
        </form>

        <div class="divider">Ø£Ùˆ</div>

        <h2>âœ‰ï¸ Ø·Ù„Ø¨ ØªÙØ¹ÙŠÙ„ Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯</h2>
        <p id="uidDisplay">Ù…Ø¹Ø±Ù Ø¬Ù‡Ø§Ø²Ùƒ: Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
        <form id="registrationForm">
            <input type="text" id="name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø«Ù„Ø§Ø«ÙŠ" required />
            <input type="tel" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù„Ù„ØªÙˆØ§ØµÙ„)" required />
            <button type="submit" id="requestBtn">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªÙØ¹ÙŠÙ„</button>
            <div class="status" id="requestStatusMessage"></div>
        </form>
    </div>

    <script>
        const loginForm = document.getElementById('loginForm');
        const registrationForm = document.getElementById('registrationForm');
        const submitBtn = document.getElementById('submitBtn');
        const requestBtn = document.getElementById('requestBtn');
        const statusMessage = document.getElementById('statusMessage');
        const requestStatusMessage = document.getElementById('requestStatusMessage');
        const uidDisplay = document.getElementById('uidDisplay');

        // 1. ØªÙˆÙ„ÙŠØ¯ Ø£Ùˆ Ø¬Ù„Ø¨ Ø§Ù„Ù€ UID
        let deviceUid = localStorage.getItem('localUid');
        if (!deviceUid) {
            // ØªÙˆÙ„ÙŠØ¯ UID Ø¨Ø³ÙŠØ· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
            deviceUid = 'device-' + Date.now() + Math.floor(Math.random() * 999);
            localStorage.setItem('localUid', deviceUid);
        }
        uidDisplay.textContent = 'Ù…Ø¹Ø±Ù Ø¬Ù‡Ø§Ø²Ùƒ: ' + deviceUid;
        
        // Ù„Ùˆ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ø¹Ø§Ù‡ ÙƒÙˆØ¯ØŒ Ø¨Ù†Ø­Ø§ÙˆÙ„ Ù†ØªØ­Ù‚Ù‚ Ù…Ù†Ù‡ ÙÙˆØ±Ø§Ù‹ Ø¹Ø´Ø§Ù† Ù†Ø¯Ø®Ù„Ù‡
        const storedCode = localStorage.getItem('activationCode');
        if (storedCode && localStorage.getItem('approved') === 'true') {
             // Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø³Ø±ÙŠØ¹Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙƒÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙ…Ø¹ØªÙ…Ø¯ Ù…Ø­Ù„ÙŠÙ‹Ø§
             window.location.href = 'https://1383ss.vercel.app';
        }


        // 2. Ø¹Ù…Ù„ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const code = document.getElementById('activationCode').value.trim();

            if (code.length !== 9 || isNaN(code)) {
                statusMessage.textContent = 'âŒ Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ ØªÙØ¹ÙŠÙ„ ØµØ­ÙŠØ­ (9 Ø£Ø±Ù‚Ø§Ù…).';
                statusMessage.style.color = '#ff4f4f';
                return;
            }

            submitBtn.disabled = true;
            statusMessage.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯...';
            statusMessage.style.color = '#ffb347';

            // Check approvedStudents using the code as key
            db.ref('approvedStudents/' + code).once('value', (snapshot) => {
                const studentData = snapshot.val();
                
                if (studentData) {
                    const storedDeviceId = studentData.deviceId;
                    
                    // Check expiry time
                    if (studentData.expiry && studentData.expiry < Date.now()) {
                        statusMessage.textContent = 'ğŸš« ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©.';
                        statusMessage.style.color = '#ff4f4f';
                    } else if (!storedDeviceId) {
                        // âœ… Ø£ÙˆÙ„ Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙƒÙˆØ¯ Ø¯Ù‡: Ù†Ø±Ø¨Ø·Ù‡ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆÙ†Ø¹Ù…Ù„ ØªÙØ¹ÙŠÙ„
                        db.ref('approvedStudents/' + code + '/deviceId').set(deviceUid)
                          .then(() => {
                              localStorage.setItem('approved', 'true');
                              localStorage.setItem('activationCode', code);
                              localStorage.setItem('localUid', deviceUid); // Ù„Ù„ØªØ£ÙƒÙŠØ¯
                              
                              statusMessage.textContent = 'âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ù†Ø¬Ø§Ø­. Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„...';
                              statusMessage.style.color = '#00f5c4';
                              setTimeout(() => { window.location.href = 'https://1383ss.vercel.app'; }, 1500);
                          });
                    } else if (storedDeviceId === deviceUid) {
                        // âœ… Ø§Ù„ÙƒÙˆØ¯ Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„ÙØ¹Ù„ Ø¨Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¯Ù‡
                        localStorage.setItem('approved', 'true');
                        localStorage.setItem('activationCode', code);
                        statusMessage.textContent = 'âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­. Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„...';
                        statusMessage.style.color = '#00f5c4';
                        setTimeout(() => { window.location.href = 'https://1383ss.vercel.app'; }, 1500);
                    } else {
                        // ğŸš« Ø§Ù„ÙƒÙˆØ¯ Ù…Ø±ØªØ¨Ø· Ø¨Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±
                        statusMessage.textContent = 'ğŸš« Ø§Ù„ÙƒÙˆØ¯ Ù…Ø±ØªØ¨Ø· Ø¨Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù‡Ù†Ø§.';
                        statusMessage.style.color = '#ff4f4f';
                    }
                } else {
                    // Ø§Ù„ÙƒÙˆØ¯ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯
                    statusMessage.textContent = 'âŒ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ ØºÙŠØ± Ù…ÙÙØ¹Ù„.';
                    statusMessage.style.color = '#ff4f4f';
                }
                submitBtn.disabled = false;
            });
        });


        // 3. Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¥Ù„Ù‰ pendingStudents
        registrationForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();

            if (!name || !phone) {
                requestStatusMessage.textContent = 'âŒ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø·Ù„Ø¨ Ø§Ù„ØªÙØ¹ÙŠÙ„.';
                requestStatusMessage.style.color = '#ff4f4f';
                return;
            }

            requestBtn.disabled = true;
            requestStatusMessage.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨...';
            requestStatusMessage.style.color = '#ffb347';

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ UID Ø¨ØªØ§Ø¹ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙƒÙ€ Key Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
            db.ref('pendingStudents/' + deviceUid).set({
                name: name,
                phone: phone,
                deviceId: deviceUid,
                requestDate: Date.now()
            })
            .then(() => {
                requestStatusMessage.textContent = 'âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­. Ø³Ù†Ø±Ø³Ù„ Ù„Ùƒ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¨Ø¹Ø¯ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.';
                requestStatusMessage.style.color = '#00f5c4';
            })
            .catch(error => {
                requestStatusMessage.textContent = 'âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨: ' + error.message;
                requestStatusMessage.style.color = '#ff4f4f';
            })
            .finally(() => {
                requestBtn.disabled = false;
            });
        });
    </script>
</body>
</html>
